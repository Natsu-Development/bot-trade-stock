name: Build and Deploy Trading App

on:
  push:
    branches: [master, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options: [production, staging]

jobs:
  # Build and push Docker images to Docker Hub
  build-images:
    runs-on: ubuntu-latest
    environment: production
    outputs:
      docker-namespace: ${{ steps.config.outputs.DOCKER_NAMESPACE }}
      broker-image: ${{ steps.config.outputs.DOCKER_NAMESPACE }}/trading-broker:${{ github.sha }}
      bot-image: ${{ steps.config.outputs.DOCKER_NAMESPACE }}/trading-bot:${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load config from production.env
        id: config
        run: |
          # Parse production.env and export to GitHub outputs
          while IFS='=' read -r key value; do
            # Skip comments and empty lines
            [[ "$key" =~ ^#.*$ || -z "$key" ]] && continue
            # Remove leading/trailing whitespace
            key=$(echo "$key" | xargs)
            value=$(echo "$value" | xargs)
            echo "${key}=${value}" >> $GITHUB_OUTPUT
          done < config/production.env

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.config.outputs.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push broker image
        uses: docker/build-push-action@v5
        with:
          context: broker
          file: broker/Dockerfile
          push: true
          tags: |
            ${{ steps.config.outputs.DOCKER_NAMESPACE }}/trading-broker:${{ github.sha }}
            ${{ steps.config.outputs.DOCKER_NAMESPACE }}/trading-broker:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push bot image
        uses: docker/build-push-action@v5
        with:
          context: bot-trade
          file: bot-trade/Dockerfile
          push: true
          tags: |
            ${{ steps.config.outputs.DOCKER_NAMESPACE }}/trading-bot:${{ github.sha }}
            ${{ steps.config.outputs.DOCKER_NAMESPACE }}/trading-bot:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build deployment configuration
  build-config:
    runs-on: ubuntu-latest
    needs: build-images
    outputs:
      artifact-id: ${{ steps.upload.outputs.artifact-id }}
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y gettext-base

      - name: Build docker-compose configuration
        run: |
          echo "Building docker-compose configuration..."
          export DOCKER_REGISTRY="${{ needs.build-images.outputs.docker-namespace }}"
          export IMAGE_TAG="${{ github.sha }}"
          envsubst '${DOCKER_REGISTRY} ${IMAGE_TAG}' < docker/docker-compose.prod.yml > docker-compose.final.yml
          echo "Configuration built successfully"

      - name: Create deployment package
        run: |
          echo "Creating deployment package..."
          mkdir -p deployment-package

          # Copy docker-compose and config files
          cp docker-compose.final.yml deployment-package/docker-compose.yml
          cp config/production.env deployment-package/production.env

          # Copy deployment scripts
          cp -r scripts/ deployment-package/scripts/
          chmod +x deployment-package/scripts/*.sh

          # Create deployment metadata
          cat > deployment-package/deployment-info.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "git_sha": "${{ github.sha }}",
            "git_ref": "${{ github.ref }}",
            "environment": "${{ github.ref_name == 'master' && 'production' || 'staging' }}",
            "images": {
              "broker": "${{ needs.build-images.outputs.broker-image }}",
              "bot": "${{ needs.build-images.outputs.bot-image }}"
            }
          }
          EOF

          echo "Deployment package contents:"
          find deployment-package -type f -exec ls -la {} \;

      - name: Upload deployment artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package-${{ github.sha }}
          path: deployment-package/
          retention-days: 30
          compression-level: 6

  # Deploy to VPS
  deploy:
    runs-on: ubuntu-latest
    needs: [build-images, build-config]
    environment: ${{ github.ref_name == 'master' && 'production' || 'staging' }}

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package-${{ github.sha }}
          path: deployment-package

      - name: Prepare deployment
        run: |
          echo "Preparing deployment to VPS"
          chmod +x deployment-package/scripts/*.sh
          echo "Deployment Information:"
          cat deployment-package/deployment-info.json | jq '.'

      - name: Setup SSH connection
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo -e "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Copy deployment package to VPS
        run: |
          cd deployment-package
          tar czf ../deployment.tar.gz .
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ../deployment.tar.gz \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/deployment.tar.gz

      - name: Execute VPS deployment
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash << 'ENDSSH'
            set -e
            
            # Extract package
            mkdir -p /tmp/deployment-package
            cd /tmp/deployment-package
            tar xzf /tmp/deployment.tar.gz
            chmod +x scripts/*.sh
            
            # Copy files to expected locations
            cp docker-compose.yml /tmp/docker-compose.yml
            cp production.env /tmp/.env.production
            
            # Export secrets for deploy script
            export MONGO_ROOT_USERNAME='${{ secrets.MONGO_ROOT_USERNAME }}'
            export MONGO_ROOT_PASSWORD='${{ secrets.MONGO_ROOT_PASSWORD }}'
            
            # Run deployment
            ./scripts/deploy-vps.sh
            
            # Cleanup
            rm -rf /tmp/deployment-package /tmp/deployment.tar.gz /tmp/docker-compose.yml /tmp/.env.production
          ENDSSH

  # Notification (runs if Telegram secrets are configured)
  notify:
    runs-on: ubuntu-latest
    needs: [build-images, build-config, deploy]
    environment: production
    if: always()

    steps:
      - name: Notify deployment status
        continue-on-error: true
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            Trading App Deployment

            Status: ${{ needs.deploy.result == 'success' && 'Success' || 'Failed' }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

            Steps:
            - Build: ${{ needs.build-images.result == 'success' && 'OK' || 'FAILED' }}
            - Config: ${{ needs.build-config.result == 'success' && 'OK' || 'FAILED' }}
            - Deploy: ${{ needs.deploy.result == 'success' && 'OK' || 'FAILED' }}

  # Cleanup old artifacts
  cleanup:
    runs-on: ubuntu-latest
    needs: [deploy]
    environment: production
    if: github.ref == 'refs/heads/master' && needs.deploy.result == 'success'

    steps:
      - name: Setup SSH for cleanup
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo -e "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Clean up old Docker images
        continue-on-error: true
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash << 'ENDSSH'
            docker system prune -f
            docker image prune -f --filter "until=72h"
            cd /opt/trading-app && ls -1t docker-compose.backup.*.yml 2>/dev/null | tail -n +4 | xargs rm -f || true
          ENDSSH
